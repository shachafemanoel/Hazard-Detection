<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,viewport-fit=cover"
  />
  <title>Live Detection â€“ Hazard Detection System</title>

  <!-- Performance optimizations: preload critical resources -->
  <link rel="preload" href="/ort/ort.webgpu.bundle.min.mjs" as="script" type="module">
  <link rel="preload" href="/ort/ort.wasm.bundle.min.mjs" as="script" type="module">
  <link rel="preload" href="/onxx_models/best.onnx" as="fetch" type="application/octet-stream" crossorigin>
  
  <!-- Core styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/camera.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
</head>

<body>
  <main class="camera-app main-content">
    <!-- Video & inference canvas -->
    <section class="camera-view" aria-label="Live camera feed">
      <div class="camera-container">
        <video id="camera-stream" data-testid="video-input" autoplay playsinline muted class="camera-video"></video>
        <canvas id="overlay-canvas" data-testid="overlay-canvas" class="overlay-canvas"></canvas>
      </div>
    </section>

    <!-- --------------- UI overlay --------------- -->
    <div class="camera-ui">
      <!-- Top bar -->
      <header class="top-bar">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span id="loading-status" aria-live="polite">Loading modelâ€¦</span>
        </div>
        <span class="model-info" id="detection-mode-info">Initializing...</span>
      </header>

      <!-- Detection badges -->
      <section class="detection-overlay">
        <div class="detection-badge">
          <i class="fas fa-search"></i>
          <span id="detection-count-badge" aria-live="polite">0 hazards</span>
        </div>
        <div class="detection-badge">
          <i class="fas fa-gauge-high"></i>
          <span id="fps-badge" aria-live="polite">0 FPS</span>
        </div>
        <div class="detection-badge" id="hazard-types-display" hidden>
          <i class="fas fa-exclamation-triangle"></i>
          <span id="hazard-types-list">â€”</span>
        </div>
        <div class="detection-badge">
          <i class="fas fa-microchip"></i>
          <span id="preprocess-ms-badge" aria-live="polite">0ms (Pre)</span>
        </div>
        <div class="detection-badge">
          <i class="fas fa-brain"></i>
          <span id="infer-ms-badge" aria-live="polite">0ms (Infer)</span>
        </div>
        <div class="detection-badge">
          <i class="fas fa-paint-brush"></i>
          <span id="postprocess-ms-badge" aria-live="polite">0ms (Post)</span>
        </div>
      </section>

      <!-- Bottom controls -->
      <footer class="bottom-controls">
        <button id="start-camera" data-testid="start-btn" class="camera-button primary" aria-label="Start">
          <i class="fas fa-play"></i>
        </button>
        <button id="stop-camera" data-testid="stop-btn" class="camera-button primary" hidden aria-label="Stop">
          <i class="fas fa-stop"></i>
        </button>
        <button id="save-report-btn" data-testid="save-report-btn" class="camera-button secondary" aria-label="Save Report">
          <i class="fas fa-save"></i>
        </button>
        <button id="switch-camera-btn" data-testid="switch-camera-btn" class="camera-button secondary" aria-label="Switch Camera" hidden>
          <i class="fas fa-sync-alt"></i>
        </button>
        <button id="settings-btn" class="camera-button secondary" aria-label="Settings" aria-expanded="false">
          <i class="fas fa-cog"></i>
        </button>
        <button id="summary-btn" class="camera-button secondary" aria-label="View Summary" data-bs-toggle="modal" data-bs-target="#detection-summary-modal">
          <i class="fas fa-chart-bar"></i>
        </button>
      </footer>

      <!-- Settings panel -->
      <section class="settings-panel" id="settings-panel">
        <div class="settings-content">
          <h3>Camera Settings</h3>
          <div class="setting-item">
            <label for="confidence-threshold">Detection Confidence</label>
            <input type="range" id="confidence-threshold" data-testid="threshold-slider" min="0.1" max="0.9" step="0.1" value="0.5">
            <span id="confidence-value">0.5</span>
          </div>
          <div class="setting-item">
            <label for="iou-threshold">IoU Threshold</label>
            <input type="range" id="iou-threshold" data-testid="iou-slider" min="0.1" max="0.9" step="0.1" value="0.45">
            <span id="iou-value">0.45</span>
          </div>
          <button class="btn btn-secondary" id="close-settings-btn">Close</button>
        </div>
      </section>

      <!-- Toast Container for Hazard Alerts -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100">
        <div id="hazardToast" class="toast align-items-center text-white bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <span id="toast-hazard-details"></span>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      </div>

      <!-- Detection Summary Modal -->
      <div class="modal fade" id="detection-summary-modal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">ðŸ“Š Detection Session Summary</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row mb-4">
                <div class="col-md-3 text-center">
                  <div class="bg-primary text-white p-3 rounded">
                    <h3 id="session-total-detections">0</h3>
                    <small>Total Detections</small>
                  </div>
                </div>
                <div class="col-md-3 text-center">
                  <div class="bg-success text-white p-3 rounded">
                    <h3 id="session-duration">0:00</h3>
                    <small>Session Duration</small>
                  </div>
                </div>
                <div class="col-md-3 text-center">
                  <div class="bg-warning text-white p-3 rounded">
                    <h3 id="session-unique-hazards">0</h3>
                    <small>Unique Hazards</small>
                  </div>
                </div>
                <div class="col-md-3 text-center">
                  <div class="bg-info text-white p-3 rounded">
                    <h3 id="session-avg-confidence">0%</h3>
                    <small>Avg Confidence</small>
                  </div>
                </div>
              </div>
              
              <h6>Recent Detections</h6>
              <div id="recent-detections-list" class="mb-3" style="max-height: 300px; overflow-y: auto;">
                <p class="text-muted">No detections recorded yet.</p>
              </div>
              
              <div class="d-flex justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" id="save-session-report" disabled>
                  <i class="fas fa-save"></i> Save Session Report
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading overlay -->
      <section class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
      </section>
    </div>

    <!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/layout.js" defer></script>
    <script type="module" src="js/session-manager.js"></script>
    <script type="module" src="js/route-guard.js"></script>
    <script type="module">
      // The route-guard.js now handles redirection, so no need for requireAuth here.
      console.log('ðŸ“¹ Camera page loaded.');
    </script>
    <!-- Optimized ONNX Runtime Loader (lazy loading) -->
    <!-- ONNX Runtime will be loaded dynamically by onnx-runtime-loader.js -->
    <!-- Camera hotfix for Railway deployment -->
    <script src="js/camera-hotfix.js"></script>
    <script type="module" src="js/apiClient.js"></script>
    <!-- Camera detection with optimized ONNX integration -->
    <script type="module" src="js/camera_detection.js"></script>
    
    <!-- Test script for development -->
    <script src="js/test_camera_functions.js"></script>
    
    <!-- Initialize App -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize notification system
            if (typeof initializeNotifications === 'function') {
                initializeNotifications();
            }
            
            // Initialize accessibility features
            initializeAccessibility();
            
            console.log('ðŸ“· Professional Hazard Detection Camera App Loaded');
        });

        // Accessibility initialization
        function initializeAccessibility() {
            // Add keyboard navigation support
            document.addEventListener('keydown', function(e) {
                // ESC key closes modals and panels
                if (e.key === 'Escape') {
                    const settingsPanel = document.getElementById('settings-panel');
                    if (settingsPanel.classList.contains('show')) {
                        settingsPanel.classList.remove('show');
                        document.getElementById('settings-btn').setAttribute('aria-expanded', 'false');
                    }
                    
                    const alertToast = document.getElementById('hazardToast');
                    if (alertToast && bootstrap.Toast.getInstance(alertToast)) {
                        bootstrap.Toast.getInstance(alertToast).hide();
                    }
                }
                
                // Space bar for capture/start/stop
                if (e.code === 'Space' && !e.target.matches('input, button, textarea')) {
                    e.preventDefault();
                    const startBtn = document.getElementById('start-camera');
                    const stopBtn = document.getElementById('stop-camera');
                    const captureBtn = document.getElementById('capture-btn');
                    
                    if (!startBtn.hidden) {
                        startBtn.click();
                    } else if (!captureBtn.hidden) {
                        captureBtn.click();
                    } else if (!stopBtn.hidden) {
                        stopBtn.click();
                    }
                }
            });

            // Announce status changes to screen readers
            const statusObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const target = mutation.target;
                        if (target.closest('[aria-live]')) {
                            // Let screen readers announce the change
                            console.log('Status update:', target.textContent);
                        }
                    }
                });
            });

            // Observe status elements
            const statusElements = document.querySelectorAll('[aria-live]');
            statusElements.forEach(element => {
                statusObserver.observe(element, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
            });
        }

        // Global error handler for better user experience
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            if (typeof notify === 'function') {
                notify('An unexpected error occurred. Please try refreshing the page.', 'error');
            }
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            if (typeof notify === 'function') {
                notify('A background process failed. The app should continue working normally.', 'warning');
            }
        });
    </script>
</body>
</html>
