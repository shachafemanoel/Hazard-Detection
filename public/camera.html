<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1.0,maximum-scale=1.0,viewport-fit=cover"
  />
  <title>Live Detection â€“ Hazard Detection System</title>

  <!-- Core styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/camera.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;500;700&display=swap" rel="stylesheet">
</head>

<body>
  <main class="camera-app main-content">
    <!-- Video & inference canvas -->
    <section class="camera-view" aria-label="Live camera feed">
      <video id="camera-stream" autoplay playsinline muted></video>
      <canvas id="overlay-canvas" aria-hidden="true"></canvas>
    </section>

    <!-- --------------- UI overlay --------------- -->
    <div class="camera-ui">
      <!-- Top bar -->
      <header class="top-bar">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span id="loading-status">Loading modelâ€¦</span>
        </div>
        <span class="model-info">Model best0408.onnx</span>
      </header>

      <!-- Detection badges -->
      <section class="detection-overlay">
        <div class="detection-badge">
          <i class="fas fa-search"></i>
          <span id="detection-count-badge">0 hazards</span>
        </div>
        <div class="detection-badge">
          <i class="fas fa-gauge-high"></i>
          <span id="fps-badge">0 FPS</span>
        </div>
        <div class="detection-badge" id="hazard-types-display" hidden>
          <i class="fas fa-exclamation-triangle"></i>
          <span id="hazard-types-list">â€”</span>
        </div>
      </section>

      <!-- Bottom controls -->
      <footer class="bottom-controls">
        <button id="start-camera" class="camera-button primary" disabled aria-label="Start">
          <i class="fas fa-play"></i>
        </button>
        <button id="stop-camera"  class="camera-button primary" hidden aria-label="Stop">
          <i class="fas fa-stop"></i>
        </button>
      </footer>

      <!-- Loading overlay -->
      <section class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
      </section>
    </div>

    <!-- Core Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/layout.js" defer></script>
    <!-- ONNX Runtime for Web -->
    <script src="ort/ort.min.js"></script>
    <script>
        // Configure ONNX Runtime for optimal web performance
        if (typeof ort !== 'undefined') {
            ort.env.wasm.wasmPaths = '/ort/';
            ort.env.wasm.numThreads = Math.min(navigator.hardwareConcurrency || 4, 4);
            ort.env.logLevel = 'error'; // Reduce logging
        }
    </script>
    <script src="js/notifications.js"></script>
    <script type="module" src="js/apiClient.js"></script>
    <!-- Camera detection with optimized ONNX integration -->
    <script type="module" src="js/upload_tf.js"></script>
    
    <!-- Initialize App -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize notification system
            if (typeof initializeNotifications === 'function') {
                initializeNotifications();
            }
            
            // Initialize accessibility features
            initializeAccessibility();
            
            console.log('ðŸ“· Professional Hazard Detection Camera App Loaded');
        });

        // Accessibility initialization
        function initializeAccessibility() {
            // Add keyboard navigation support
            document.addEventListener('keydown', function(e) {
                // ESC key closes modals and panels
                if (e.key === 'Escape') {
                    const settingsPanel = document.getElementById('settings-panel');
                    if (settingsPanel.classList.contains('show')) {
                        settingsPanel.classList.remove('show');
                        document.getElementById('settings-btn').setAttribute('aria-expanded', 'false');
                    }
                    
                    const alertModal = document.getElementById('hazard-alert-modal');
                    if (alertModal.style.display !== 'none') {
                        alertModal.style.display = 'none';
                    }
                }
                
                // Space bar for capture/start/stop
                if (e.code === 'Space' && !e.target.matches('input, button, textarea')) {
                    e.preventDefault();
                    const startBtn = document.getElementById('start-camera');
                    const stopBtn = document.getElementById('stop-camera');
                    const captureBtn = document.getElementById('capture-btn');
                    
                    if (startBtn.style.display !== 'none') {
                        startBtn.click();
                    } else if (captureBtn.style.display !== 'none') {
                        captureBtn.click();
                    } else if (stopBtn.style.display !== 'none') {
                        stopBtn.click();
                    }
                }
            });

            // Announce status changes to screen readers
            const statusObserver = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' || mutation.type === 'characterData') {
                        const target = mutation.target;
                        if (target.closest('[aria-live]')) {
                            // Let screen readers announce the change
                            console.log('Status update:', target.textContent);
                        }
                    }
                });
            });

            // Observe status elements
            const statusElements = document.querySelectorAll('[aria-live]');
            statusElements.forEach(element => {
                statusObserver.observe(element, {
                    childList: true,
                    subtree: true,
                    characterData: true
                });
            });
        }

        // Global error handler for better user experience
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            if (typeof notify === 'function') {
                notify('An unexpected error occurred. Please try refreshing the page.', 'error');
            }
        });

        // Unhandled promise rejection handler
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
            if (typeof notify === 'function') {
                notify('A background process failed. The app should continue working normally.', 'warning');
            }
        });
    </script>
</body>
</html>